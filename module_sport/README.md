# 体育打卡README

## 架构层级

体育打卡（sport模块）整体上采用了**`mvvm架构`**，项目结构按照mvvm的标准大致分为：

- **`Model层`** : 包含网络请求用到的Bean类、Retrofit用到的ApiService等
- **`View层`** : 包含Activity、Fragment以及相关的Adapter等
- **`ViewModel层`** : 包含Activity以及Fragment各自的ViewModel
- **`Repository层`** : 判断体育打卡的数据是从本地拿还是进行网络请求（距离上次请求时间超过4小时才再次请求）

### 运行流程

整个运行流程大致如下：

1. Model层返回RxJava的Single给Repository层
2. Repository层利用Flow将获取到的数据发送给ViewModel层
3. ViewModel层收集数据，并更新对应的LiveData
4. View层通过观察ViewModel提供的LiveData来更新界面状态，加载数据和处理对应的异常

## 项目难点

### 视觉定制的刷新头

最开始拿到刷新icon的时候没有什么头绪，后来发现一个比较好用的第三方刷新库 `SmartRefreshLayout` 可以自定义刷新头，将视觉给的刷新icon放进去，利用属性动画进行旋转，并且在手指下拉的同时也转动角度并记录，刷新时接着手指松开时的角度继续旋转。

### 淡淡的阴影的实现

对于要用的会渐变的淡淡的阴影，实现的时候没找到比较有效的办法，最后使用四个方向的线性渐变阴影叠加完成，已经将对应的xml文件抽出放进了**`lib_config`**的**`drawable`**文件夹里面。

## 特殊设计

### 判断是否已绑定ids

由于没有专门检验是否已绑定ids的接口，因此直接获取体育打卡的数据，通过后端返回的结果来判断是否绑定了ids，并且用一个sp： `sSpIdsIsBind` (位于 `SPTable.kt` 文件内 )来保存绑定ids的状态，在请求体育打卡数据后更新其值。

### 刷新需要间隔4小时

因为体育打卡的数据是现扒的，接口速度很慢，并且每次请求一遍就会登录一遍，如果多次登录会导致账号被封禁，因此利用仓库层做一个本地的缓存，如果没到刷新时间就直接从本地拿缓存的体育打卡数据，如果距离上次刷新时间超过4小时则刷新数据，防止因频繁登录导致封号。